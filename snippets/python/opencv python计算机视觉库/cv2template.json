{
  "cv2 模板匹配方法测试函数": {
    "prefix": ["cv2 def test_cv2_TM"],
    "body": [
      "def test_cv2_TM_gray(img, templ):",
      "    \"\"\"",
      "    OpenCV模板匹配方法测试(修改分辨率需要重新设置匹配目标)",
      "    测试模式:gray灰度模式",
      "    [一般情况:cv2.TM_CCOEFF_NORMED 效果最佳,cv2.TM_CCORR_NORMED 其次]",
      "    [彩色模式:cv2.TM_CCOEFF 效果最佳]",
      "    Args:",
      "        img (str | Path): 被匹配图像路径",
      "        template (str | Path): 匹配模板图像路径",
      "    \"\"\"",
      "    # 读取需匹配图像",
      "    img = cv2.imread(str(img))  # 读取需匹配图像",
      "    # 读取匹配模板图像",
      "    templ = cv2.imread(str(templ))  # 读取匹配模板图像",
      "",
      "    # 图像灰度",
      "    img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)  # COLOR_BGR2GRAY: 灰度模式",
      "    templ_gray = cv2.cvtColor(templ, cv2.COLOR_BGR2GRAY)  # COLOR_BGR2GRAY: 灰度模式",
      "",
      "    # 模板匹配方法列表",
      "    templateMethodNames = [",
      "        'TM_SQDIFF',  # *平方差匹配法[值越小匹配越好|对亮度变化敏感|完全匹配时为0]",
      "        # 计算模板与图像区域的平方差",
      "        # 公式: R(x,y) = Σ[T(x',y') - I(x+x',y+y')]²",
      "        # 最佳匹配: 最小值 (0表示完美匹配)",
      "        'TM_SQDIFF_NORMED',  # *归一化平方差匹配法[对图像亮度变化不敏感|结果在0-1之间,便于比较|最常用的方法之一]",
      "        # 平方差的归一化版本",
      "        # 公式: R(x,y) = Σ[T(x',y') - I(x+x',y+y')]² / √(ΣT(x',y')² • ΣI(x+x',y+y')²)",
      "        # 最佳匹配: 最小值 (0-1范围，0表示完美匹配)",
      "        'TM_CCORR',  # *相关匹配法[值越大匹配越好|对亮度变化敏感|亮区容易产生高值]",
      "        # 计算模板与图像区域的相关性",
      "        # 公式: R(x,y) = Σ[T(x',y') • I(x+x',y+y')]",
      "        # 最佳匹配: 最大值",
      "        'TM_CCORR_NORMED',  # *归一化相关匹配法[对亮度变化不敏感|结果在0-1之间|性能较好]",
      "        # 相关性的归一化版本",
      "        # 公式: R(x,y) = Σ[T(x',y') • I(x+x',y+y')] / √(ΣT(x',y')² • ΣI(x+x',y+y')²)",
      "        # 最佳匹配: 最大值 (0-1范围，1表示完美匹配)",
      "        'TM_CCOEFF',  # *相关系数匹配法[考虑均值,对亮度变化不敏感|值域为实数,可能为负|能处理模板与图像亮度不一致的情况]",
      "        # 计算模板与图像区域的相关系数",
      "        # 公式: R(x,y) = Σ[T'(x',y') • I'(x+x',y+y')]",
      "        # 其中 T' = T - T.mean(), I' = I - I.mean()",
      "        # 最佳匹配: 最大值",
      "        'TM_CCOEFF_NORMED',  # *归一化相关系数匹配法[最常用的方法|对亮度变化不敏感|结果在-1到1之间|抗干扰能力强]",
      "        # 相关系数的归一化版本",
      "        # 公式: R(x,y) = Σ[T'(x',y') • I'(x+x',y+y')] / √(ΣT'(x',y')² • ΣI'(x+x',y+y')²)",
      "        # 最佳匹配: 最大值 (-1到1范围，1表示完美匹配)",
      "    ]",
      "",
      "    for method_name in templateMethodNames:",
      "        method = getattr(cv2, method_name)",
      "        print(f'[bold]匹配方法:{method}-{method_name}')",
      "",
      "        method_img = img.copy()  # *复制图片对象",
      "",
      "        # *RGB彩色模式*模板匹配",
      "        res = cv2.matchTemplate(img, templ, method)",
      "        # *结果解析 -> tuple[index]: (min_val最小值, max_val最大值, min_loc左上角坐标, max_loc右下角坐标)",
      "        min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(res)",
      "        top_left = max_loc  # *左上角坐标",
      "        bottom_right = (top_left[0] + templ.shape[1], top_left[1] + templ.shape[0])  # *右下角坐标",
      "        width = bottom_right[0] - top_left[0]  # *宽度",
      "        height = bottom_right[1] - top_left[1]  # *高度",
      "        cv2.rectangle(method_img, top_left, bottom_right, (0, 255, 0), -1)  # *绘制矩形:RGB(0, 255, 0)-绿色;线宽2|填充-1",
      "        print(f'RGB彩色模式匹配结果\\t最小值={min_val};\\t最大值={max_val};')",
      "        print(f'RGB彩色模式匹配结果\\t最小值坐标={min_loc};\\t最大值坐标={max_loc};')",
      "        print(f'RGB彩色模式匹配结果\\t宽度={width};\\t高度={height};')",
      "",
      "        # *Gray灰度模式*模板匹配",
      "        res_gray = cv2.matchTemplate(img_gray, templ_gray, method)",
      "        # *获取匹配结果:最小值, 最大值, 最小值坐标, 最大值坐标",
      "        min_val_g, max_val_g, min_loc_g, max_loc_g = cv2.minMaxLoc(res_gray)",
      "        top_left_g = max_loc_g  # *左上角坐标",
      "        bottom_right_g = (top_left_g[0] + templ.shape[1], top_left_g[1] + templ.shape[0])  # *右下角坐标",
      "        width_g = bottom_right_g[0] - top_left_g[0]  # *宽度",
      "        height_g = bottom_right_g[1] - top_left_g[1]  # *高度",
      "        cv2.rectangle(method_img, top_left_g, bottom_right_g, (0, 0, 255), 2)  # *绘制矩形:RGB(0, 0, 255)-红色;2-线宽",
      "        print(f'Gray灰度模式匹配结果\\t最小值={min_val_g};\\t最大值={max_val_g};')",
      "        print(f'Gray灰度模式匹配结果\\t最小值坐标={min_loc_g};\\t最大值坐标={max_loc_g};')",
      "        print(f'Gray灰度模式匹配结果\\t宽度={width_g};\\t高度={height_g};')",
      "",
      "        # TODO:独立窗口显示匹配结果",
      "        method_img = cv2.resize(method_img, (0, 0), fx=0.5, fy=0.5)  # *缩放图片:cv2.imread()读取的图像对象;(0, 0)不直接指定尺寸;fx/fy缩放比例因子",
      "        cv2.imshow(f'{method_name}', method_img)  # *显示 cv2.imread() 读取对象图片",
      "        cv2.waitKey(0)  # *图像显示时间函数(0 为无限时间的显示函数)",
      "        cv2.destroyAllWindows()  # *按下任意键便可关闭窗口",
      "    return True",
      ""
    ],
    "description": ["cv2 模板匹配方法测试函数"]
  }
}
